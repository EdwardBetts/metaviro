import os
from snakemake.utils import R

"""TODO:
* Generate short / long reads
* Account for multiple batches 
"""

ALLDOMAIN=["viruses","bact","euk","archea"]


ROOTDIR=os.getcwd()

# ResampleID="batch_1"


### BLAST Db generation 
BLASTDBEXTENSIONS=['nhr','nin','nnd','nni','nog','nsd','nsi','nsq']
DB_DIR="blast_dbs/"

rule make_db:
	input: "../../data/full_ncbi/{domain}.fa"
	params:
		db_name="{domain}_blastdb",
		db_path="blast_dbs/{domain}_blastdb"
	# output: "{domain}_blastdb.nhr", "{domain}_blastdb.nin", "{domain}_blastdb.nnd", "{domain}_blastdb.nni", "{domain}_blastdb.nog", "{domain}_blastdb.nsd", "{domain}_blastdb.nsi", "{domain}_blastdb.nsq"
	output: DB_DIR+"{domain}_blastdb.nhr"
	shell:
		"makeblastdb -parse_seqids -out {params.db_path} -in {input} -dbtype nucl"


rule clean_db:
	shell:
		"rm *_blastdb.n*"

rule list_db_content:
	input: DB_DIR+"{domain}_blastdb.nhr"
	output: DB_DIR+"{domain}_blastdb_content.txt"
	run:
		db_name=os.path.splitext(input[0])[0]
		shell("""blastdbcmd -entry all -db {db_name} -outfmt "%g\t%a\t%i\t%t\t%l" > {output}""")




### Contig sampling 

ruleorder: contigs_sample_indices_short>contigs_sample_indices


rule contigs_sample_indices_short:
	input: DB_DIR+"{domain}_blastdb_content.txt"
	output: "150nt_{ResampleID}/{domain}_sampling_contig_indices.txt"
	params:
		N_CONTIGS_PER_DOMAIN="10000"
	shell:
		"""../../bin/contig_sampling_with_blast.py -l 150 -s 0 -u -n {params.N_CONTIGS_PER_DOMAIN} {input} -o {output}"""

rule contigs_sample_indices:
	input: DB_DIR+"{domain}_blastdb_content.txt"
	output: "{ContigLength}nt_{ResampleID}/{domain}_sampling_contig_indices.txt"
	params:
		N_CONTIGS_PER_DOMAIN="10000"
	shell:
		"""../../bin/contig_sampling_with_blast.py -l {wildcards.ContigLength} -u -n {params.N_CONTIGS_PER_DOMAIN} {input} -o {output}"""

rule contigs_sample_extract_sequences:
	input: seq="{ResampleID}/{domain}_sampling_contig_indices.txt"
	output: temp("{ResampleID}/{domain}_contigs.fa")
	params:
		db_path=DB_DIR+"{domain}_blastdb"
	shell:
		"""blastdbcmd -db {params.db_path} -entry_batch {input.seq} > {output}"""




rule kmerize:
	input: "{ResampleID}/{domain}_contigs.fa"
	output: "{ResampleID}/{domain}_k{kmerL,\d+}_mers.tsv"
	log:"kmerize_log.txt"
	shell:
		"../../bin/kmerize.py -k {wildcards.kmerL} {input} -o {output}"


rule measure_kDN:
	input: kmer_file="{ResampleID}/{domain}_k3_mers.tsv",script="sub_group_analysis.R",bact_annot="gi_mapping/bact_annotations_gi.RData",virus_annot="gi_mapping/viruses_annotations_gi.RData"
	output: "{ResampleID}/{domain}_{classLabel}_by_gi_kDN.csv", "{ResampleID}/{domain}_{classLabel}_distribution_kDN.pdf", "{ResampleID}/{domain}_{classLabel}_mean_kDN.csv", "{ResampleID}/{domain}_{classLabel}_nulls_kDN.pdf"
	threads:2
	params:
		N_PERMUTATIONS="10",
		N_GROUP_SAMPLING="10",
		N_NEAREST_NEIGHBORS="73",
		n_majority_class_choice_group="4",
		n_majority_class_choice_sub_group="6",
		n_majority_class_choice_host="6"

	run:
		os.chdir(ROOTDIR)
		if wildcards.classLabel=="Group":
			n_majority_class_choice=params.n_majority_class_choice_group
		elif wildcards.classLabel=="SubGroup":
			n_majority_class_choice=params.n_majority_class_choice_sub_group
		elif wildcards.classLabel=="Host":
			n_majority_class_choice=params.n_majority_class_choice_host

		R("""library(logging,quietly=T)
			logReset()
			addHandler(writeToConsole)
			loginfo("Starting; in dir %s",getwd())

			setwd("{wildcards.ResampleID}")
			SOURCE_KMERS="{wildcards.domain}_k3_mers.tsv"
			CLASS="{wildcards.domain}"
			GI_MAPPING="../gi_mapping/{wildcards.domain}_annotations_gi.RData"
			classLabelsTag="{wildcards.classLabel}" 
			
			n_cores={threads}
			N_PERMUTATIONS={params.N_PERMUTATIONS}
			N_GROUP_SAMPLING={params.N_GROUP_SAMPLING}
			N_NEAREST_NEIGHBORS={params.N_NEAREST_NEIGHBORS}

			N_MAJORITY_CLASS_LABELS={n_majority_class_choice}

			loginfo("Will process {input.kmer_file}")
			source("../prepare_data.R")
			source("../fast_sparse_knn.R")
			loginfo("Data loaded and annotated")
			source("../sub_group_analysis.R")			
		""")

rule some_hardness:
	input: viruses=expand("Resample_{res_id}_{cont_length}nt/viruses_{classLabels}_distribution_kDN.pdf",res_id=range(1,3),cont_length=[150,500,1000],classLabels=['Group','SubGroup']), bact=expand("Resample_{res_id}_{cont_length}nt/bact_{classLabels}_distribution_kDN.pdf",res_id=range(1,3),cont_length=[150,500,1000],classLabels=['Group','SubGroup']),





### GI mapping 

"""We need to convert GenBank GI identifier to the corresponding TaxID in order to get species annotations
We build here the mappings that we'll use
This might take up to 30min and require 4Gb of memory
We follow advices from https://www.biostars.org/p/10959/: 
	If you have a LARGE number of IDS and don't want to be limited by the EUtils pipe there is a set of files in the ftp directory: ftp://ftp.ncbi.nih.gov/pub/taxonomy/ that map TaxIDs to various other identifiers. This would only be helpful if you had too many IDS to submit to EUtils.
We process the taxonomy file, map it back and join it with the GENOME_REPORTS. 
"""

ruleorder: get_precomputed_taxid_maps > map_genome_reports > get_taxid_map

rule get_taxid_map:
	input: 
	output: all_gi=protected("gi_mapping/gi_taxid_nucl.RData"), temp_file=temp("gi_mapping/gi_taxid_nucl.dmp")
	run:
		shell("curl ftp://ftp.ncbi.nih.gov/pub/taxonomy/gi_taxid_nucl.dmp.gz")
		shell("gunzip gi_taxid_nucl.dmp.gz")
		R("""source("prepare_GI_annotations.R")""")

rule map_genome_reports:
	input:"../../data/GENOME_REPORTS/viruses.txt","gi_mapping/gi_taxid_nucl.RData","../../data/GENOME_REPORTS/prokaryotes.txt"
	output:		viruses_gi=protected("gi_mapping/viruses_annotations_gi.RData"),bact_gi=protected("gi_mapping/bact_annotations_gi.RData")
	run:
		R("""source("prepare_GenBank_GenomeReports.R")""")


rule get_precomputed_taxid_maps:
	output: viruses_gi="gi_mapping/viruses_annotations_gi.RData",bact_gi="gi_mapping/bact_annotations_gi.RData"
	input: "gi_mapping_BACK"
	shell:
		"""
		cp  gi_mapping_BACK/* gi_mapping/
		touch gi_mapping/*

		"""



## Some results rules 

rule bact_hardness:
	input: "500nt_Resample_1/bact_Group_distribution_kDN.pdf","500nt_Resample_1/bact_SubGroup_distribution_kDN.pdf","150nt_Resample_2/bact_SubGroup_distribution_kDN.pdf","150nt_Resample_2/bact_Group_distribution_kDN.pdf"


rule all_blast_db:
	input: expand('{domain}_blastdb',domain=ALLDOMAIN)

rule viruses_db:
	input: "blast_dbs/viruses_blastdb.nhr"


rule list_all_contents:
	input: expand(DB_DIR+"{domain}_blastdb_content.txt",domain=ALLDOMAIN)
